<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Stock Tracker</title>
      <script src="https://cdn.tailwindcss.com"></script>
      <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
      <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
      <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
      <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
   </head>
   <body class="bg-gray-100 dark:bg-gray-900 transition-colors duration-200">
      <div id="root"></div>
      <script type="text/babel">
         const { useState, useEffect, useCallback, useRef } = React;
         
         function DarkModeToggle() {
             const toggleDarkMode = () => {
                 const html = document.documentElement;
                 html.classList.toggle('dark');
                 localStorage.setItem('darkMode', html.classList.contains('dark'));
             };
         
             return (
                 <button onClick={toggleDarkMode} className="p-2 rounded-lg bg-gray-200 dark:bg-gray-700">
                     <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 text-gray-800 dark:text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                         <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                     </svg>
                 </button>
             );
         }
         
         function StockForm({ onAddStock }) {
             const [symbol, setSymbol] = useState('');
         
             const handleSubmit = (e) => {
                 e.preventDefault();
                 if (symbol) {
                     onAddStock(symbol.toUpperCase());
                     setSymbol('');
                 }
             };
         
             return (
                 <div className="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 mb-8">
                     <form onSubmit={handleSubmit} className="flex gap-4">
                         <input
                             type="text"
                             value={symbol}
                             onChange={(e) => setSymbol(e.target.value)}
                             placeholder="Enter stock symbol (e.g., AAPL)"
                             className="flex-1 p-2 border rounded-lg dark:bg-gray-700 dark:text-white dark:border-gray-600"
                         />
                         <button
                             type="submit"
                             className="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition-colors"
                         >
                             Add Stock
                         </button>
                     </form>
                 </div>
             );
         }
         
         function StockCard({ symbol, onRemove }) {
             const chartRef = useRef(null);
             const chartInstance = useRef(null);
             const [stockData, setStockData] = useState(null);
             const [isLoading, setIsLoading] = useState(true);
         
             const createChart = useCallback((data) => {
                 if (chartRef.current) {
                     // Destroy existing chart if it exists
                     if (chartInstance.current) {
                         chartInstance.current.destroy();
                     }
         
                     const ctx = chartRef.current.getContext('2d');
                     chartInstance.current = new Chart(ctx, {
                         type: 'line',
                         data: {
                             labels: data.aggs.map(agg => 
                                 new Date(agg.date).toLocaleDateString()),
                             datasets: [{
                                 label: 'Price',
                                 data: data.aggs.map(agg => agg.close),
                                 borderColor: '#3B82F6',
                                 tension: 0.1
                             }]
                         },
                         options: {
                             responsive: true,
                             maintainAspectRatio: false,
                             plugins: {
                                 legend: {
                                     display: false
                                 }
                             },
                             scales: {
                                 y: {
                                     ticks: {
                                         color: document.documentElement.classList.contains('dark') ? '#fff' : '#374151'
                                     }
                                 },
                                 x: {
                                     ticks: {
                                         color: document.documentElement.classList.contains('dark') ? '#fff' : '#374151'
                                     }
                                 }
                             }
                         }
                     });
                 }
             }, []);
         
             const fetchStockData = useCallback(async () => {
                 try {
                     setIsLoading(true);
                     const response = await fetch(`/api/stock/${symbol}`);
                     const data = await response.json();
                     
                     if (data.success) {
                         setStockData(data.data);
                         // Wait for next render cycle before creating chart
                         setTimeout(() => {
                             createChart(data.data);
                             setIsLoading(false);
                         }, 0);
                     }
                 } catch (error) {
                     console.error('Error fetching stock data:', error);
                     setIsLoading(false);
                 }
             }, [symbol, createChart]);
         
             useEffect(() => {
                 fetchStockData();
                 const interval = setInterval(fetchStockData, 60000);
                 return () => {
                     clearInterval(interval);
                     if (chartInstance.current) {
                         chartInstance.current.destroy();
                     }
                 };
             }, [fetchStockData]);
         
             // Handle dark mode changes
             useEffect(() => {
                 const observer = new MutationObserver((mutations) => {
                     mutations.forEach((mutation) => {
                         if (mutation.attributeName === 'class' && stockData) {
                             createChart(stockData);
                         }
                     });
                 });
         
                 observer.observe(document.documentElement, {
                     attributes: true,
                     attributeFilter: ['class']
                 });
         
                 return () => observer.disconnect();
             }, [createChart, stockData]);
         
             if (!stockData) {
                 return (
                     <div className="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 min-h-[400px] flex items-center justify-center">
                         <div className="text-gray-600 dark:text-gray-400">Loading...</div>
                     </div>
                 );
             }
         
             const latestData = stockData.aggs[stockData.aggs.length - 1];
         
             return (
                 <div className="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
                     <div className="flex justify-between items-start mb-4">
                         <div>
                             <h2 className="text-xl font-bold text-gray-800 dark:text-white">{symbol}</h2>
                             <p className="text-gray-600 dark:text-gray-400">{stockData.details.name}</p>
                         </div>
                         <button
                             onClick={onRemove}
                             className="text-gray-500 hover:text-red-500 dark:text-gray-400 dark:hover:text-red-400"
                         >
                             <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                 <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" />
                             </svg>
                         </button>
                     </div>
                     <div className="relative h-[200px] mb-4">
                         {isLoading ? (
                             <div className="absolute inset-0 flex items-center justify-center">
                                 <div className="text-gray-600 dark:text-gray-400">Loading chart...</div>
                             </div>
                         ) : (
                             <canvas ref={chartRef} height="200"></canvas>
                         )}
                     </div>
                     <div className="grid grid-cols-2 gap-4">
                         <div className="text-center">
                             <p className="text-gray-600 dark:text-gray-400">Current Price</p>
                             <p className="text-lg font-bold text-gray-800 dark:text-white">
                                 ${latestData.close.toFixed(2)}
                             </p>
                         </div>
                         <div className="text-center">
                             <p className="text-gray-600 dark:text-gray-400">Volume</p>
                             <p className="text-lg font-bold text-gray-800 dark:text-white">
                                 {latestData.volume.toLocaleString()}
                             </p>
                         </div>
                     </div>
                 </div>
             );
         }
         
         function App() {
             const [stocks, setStocks] = useState(() => {
                 const saved = localStorage.getItem('trackedStocks');
                 return saved ? JSON.parse(saved) : [];
             });
         
             useEffect(() => {
                 if (localStorage.getItem('darkMode') === 'true') {
                     document.documentElement.classList.add('dark');
                 }
             }, []);
         
             useEffect(() => {
                 localStorage.setItem('trackedStocks', JSON.stringify(stocks));
             }, [stocks]);
         
             const addStock = (symbol) => {
                 if (!stocks.includes(symbol)) {
                     setStocks([...stocks, symbol]);
                 }
             };
         
             const removeStock = (symbolToRemove) => {
                 setStocks(stocks.filter(symbol => symbol !== symbolToRemove));
             };
         
             return (
                 <div className="container mx-auto px-4 py-8">
                     <div className="flex justify-between items-center mb-8">
                         <h1 className="text-3xl font-bold text-gray-800 dark:text-white">Stock Tracker</h1>
                         <DarkModeToggle />
                     </div>
         
                     <StockForm onAddStock={addStock} />
         
                     <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                         {stocks.map(symbol => (
                             <StockCard
                                 key={symbol}
                                 symbol={symbol}
                                 onRemove={() => removeStock(symbol)}
                             />
                         ))}
                     </div>
                 </div>
             );
         }
         
         const root = ReactDOM.createRoot(document.getElementById('root'));
         root.render(<App />);
      </script>
   </body>
</html>